<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≤ Fast Dice Game - Base Mainnet</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .dice-glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .winner-animation { animation: bounce 1s infinite; }
        .gradient-text { background: linear-gradient(45deg, #f59e0b, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">
    
    <div class="max-w-lg w-full">
        
        <!-- Header -->
        <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl mb-6 border border-white/20">
            <div class="text-center">
                <h1 class="text-5xl font-bold text-white mb-2">üé≤</h1>
                <h2 class="text-3xl font-bold gradient-text mb-4">Fast Dice Game</h2>
                <div class="flex justify-center space-x-4 text-sm text-white/70">
                    <span>‚ö° Base Mainnet</span>
                    <span>üí∞ 0.01 USDC Prize</span>
                    <span>‚è±Ô∏è 10s Cooldown</span>
                </div>
            </div>
        </div>

        <!-- Main Game Card -->
        <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl border border-white/20">
            
            <!-- Wallet Section -->
            <div id="wallet-section" class="text-center mb-8">
                <button id="connect-btn" onclick="connectWallet()" 
                        class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 shadow-xl">
                    <span class="mr-2">üîó</span> Connect Wallet
                </button>
                
                <div id="wallet-connected" style="display: none;" class="bg-green-500/20 border border-green-400/30 rounded-2xl p-4 mt-4">
                    <p class="text-green-300 font-semibold mb-2">‚úÖ Wallet Connected</p>
                    <p id="wallet-address" class="text-white/70 text-sm font-mono"></p>
                </div>
            </div>

            <!-- Game Stats -->
            <div id="game-stats" class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-black/20 rounded-xl p-3 text-center">
                    <div id="total-games" class="text-2xl font-bold text-white">0</div>
                    <div class="text-xs text-white/60">Total Games</div>
                </div>
                <div class="bg-black/20 rounded-xl p-3 text-center">
                    <div id="total-wins" class="text-2xl font-bold text-green-400">0</div>
                    <div class="text-xs text-white/60">Total Wins</div>
                </div>
                <div class="bg-black/20 rounded-xl p-3 text-center">
                    <div id="win-rate" class="text-2xl font-bold text-yellow-400">0%</div>
                    <div class="text-xs text-white/60">Win Rate</div>
                </div>
            </div>

            <!-- Contract Balance -->
            <div id="contract-info" class="bg-yellow-400/20 border border-yellow-400/40 rounded-2xl p-4 mb-6 text-center">
                <p class="text-yellow-300 font-semibold">üí∞ Prize Pool</p>
                <p id="contract-balance" class="text-white text-lg font-mono">Loading...</p>
                <p id="available-prizes" class="text-yellow-200 text-sm">Available prizes: 0</p>
            </div>

            <!-- Cooldown Timer -->
            <div id="cooldown-section" style="display: none;" class="bg-red-400/20 border border-red-400/40 rounded-2xl p-4 mb-6 text-center">
                <p class="text-red-300 font-semibold">‚è±Ô∏è Cooldown Active</p>
                <p id="cooldown-timer" class="text-white text-2xl font-mono">0s</p>
                <p class="text-red-200 text-sm">Wait before next game</p>
            </div>

            <!-- Dice Selection -->
            <div id="game-section" style="display: none;">
                <h3 class="text-white text-center font-bold text-xl mb-6">üéØ Choose Your Number (1-6)</h3>
                
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <button class="dice-btn bg-gradient-to-br from-red-400 to-red-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(1)">
                        <div class="text-4xl">‚öÄ</div>
                        <div class="text-sm mt-1">1</div>
                    </button>
                    <button class="dice-btn bg-gradient-to-br from-orange-400 to-orange-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(2)">
                        <div class="text-4xl">‚öÅ</div>
                        <div class="text-sm mt-1">2</div>
                    </button>
                    <button class="dice-btn bg-gradient-to-br from-yellow-400 to-yellow-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(3)">
                        <div class="text-4xl">‚öÇ</div>
                        <div class="text-sm mt-1">3</div>
                    </button>
                    <button class="dice-btn bg-gradient-to-br from-green-400 to-green-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(4)">
                        <div class="text-4xl">‚öÉ</div>
                        <div class="text-sm mt-1">4</div>
                    </button>
                    <button class="dice-btn bg-gradient-to-br from-blue-400 to-blue-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(5)">
                        <div class="text-4xl">‚öÑ</div>
                        <div class="text-sm mt-1">5</div>
                    </button>
                    <button class="dice-btn bg-gradient-to-br from-purple-400 to-purple-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(6)">
                        <div class="text-4xl">‚öÖ</div>
                        <div class="text-sm mt-1">6</div>
                    </button>
                </div>
                
                <button id="play-btn" onclick="playGame()" disabled
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-2xl font-bold text-xl hover:from-green-600 hover:to-emerald-700 transition-all transform hover:scale-105 shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
                    Select a number first
                </button>
            </div>

            <!-- Game Result -->
            <div id="result-section" style="display: none;" class="text-center mt-6">
                <div id="result-card" class="rounded-2xl p-8 mb-6">
                    <div id="result-icon" class="text-8xl mb-4"></div>
                    <h3 id="result-title" class="font-bold text-2xl mb-4"></h3>
                    <div class="grid grid-cols-2 gap-4 text-lg mb-4">
                        <div class="bg-black/20 rounded-xl p-3">
                            <p class="text-white/70 text-sm">Your Choice</p>
                            <p id="user-choice" class="text-2xl font-bold text-yellow-300"></p>
                        </div>
                        <div class="bg-black/20 rounded-xl p-3">
                            <p class="text-white/70 text-sm">Dice Result</p>
                            <p id="dice-result" class="text-2xl font-bold text-yellow-300"></p>
                        </div>
                    </div>
                    <div id="prize-info"></div>
                    <div id="transaction-link" class="mt-4"></div>
                </div>
                
                <button onclick="resetGame()" 
                        class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white py-4 rounded-2xl font-bold text-xl hover:from-gray-600 hover:to-gray-700 transition-all">
                    üé≤ Play Again
                </button>
            </div>
        </div>
        
        <!-- Status Messages -->
        <div id="status-message" class="mt-6 text-center" style="display: none;">
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4 border border-white/20">
                <p id="status-text" class="text-white"></p>
            </div>
        </div>
        
        <!-- Contract Info -->
        <div class="mt-6 text-center text-white/50 text-xs">
            <p class="mb-1">üìÑ FastDiceGame Contract</p>
            <p id="contract-address-display">Deploy and update address</p>
        </div>
    </div>

    <script>
        // Contract Configuration
        const CONTRACT_ADDRESS = "0xeA3F62030029DD99E487f6A3c415dc31e03337FD";
        const BASE_MAINNET_CHAIN_ID = 8453;
        
        // Multiple RPC endpoints for maximum reliability
        const BASE_RPC_ENDPOINTS = [
            'https://mainnet.base.org',
            'https://base-mainnet.public.blastapi.io',
            'https://base.gateway.tenderly.co',
            'https://base-rpc.publicnode.com'
        ];
        
        // Contract ABI
        const CONTRACT_ABI = [
            "function play(uint256 chosenNumber) external",
            "function getCooldown(address player) external view returns (uint256)",
            "function getContractBalance() external view returns (uint256)",
            "function getAvailablePrizes() external view returns (uint256)",
            "function getGameStats() external view returns (uint256 games, uint256 wins, uint256 winRate)",
            "function lastPlayTime(address) external view returns (uint256)",
            "event GamePlayed(address indexed player, uint256 chosenNumber, uint256 rolledNumber, bool won)",
            "event PrizeClaimed(address indexed player, uint256 amount)"
        ];
        
        // Game State
        let provider, signer, contract, userAddress;
        let readOnlyProvider;
        let selectedChoice = 0;
        let cooldownInterval;
        let farcasterSdk = null;
        
        // Dice symbols
        const diceSymbols = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
        
        // Enhanced Farcaster provider wrapper
        class FarcasterProviderWrapper {
            constructor(originalProvider) {
                this.originalProvider = originalProvider;
                this.isMetaMask = false;
                this.isFarcaster = true;
                this.chainId = '0x2105';
                this.selectedAddress = null;
                this._eventListeners = new Map();
            }
            
            async request(args) {
                console.log('üîÑ Provider request:', args.method, args.params);
                
                switch (args.method) {
                    case 'eth_chainId':
                        return this.chainId;
                        
                    case 'eth_accounts':
                    case 'eth_requestAccounts':
                        try {
                            if (this.originalProvider.request) {
                                const accounts = await this.originalProvider.request({ method: 'eth_requestAccounts' });
                                if (accounts && accounts.length > 0) {
                                    this.selectedAddress = accounts[0];
                                    console.log('‚úÖ Got accounts via request:', accounts);
                                    return accounts;
                                }
                            }
                            
                            if (this.selectedAddress) {
                                return [this.selectedAddress];
                            }
                            
                            throw new Error('No accounts available');
                        } catch (error) {
                            console.error('‚ùå Failed to get accounts:', error);
                            throw error;
                        }
                        
                    case 'net_version':
                        return '8453';
                        
                    case 'eth_estimateGas':
                        return '0x186A0';
                        
                    case 'eth_gasPrice':
                        return '0x3B9ACA00';
                        
                    case 'eth_sendTransaction':
                        console.log('üì§ Sending transaction via Farcaster:', args.params[0]);
                        
                        try {
                            const txParams = {
                                ...args.params[0],
                                gas: '0x186A0',
                                gasPrice: '0x3B9ACA00'
                            };
                            
                            if (this.originalProvider.request) {
                                const result = await this.originalProvider.request({
                                    method: 'eth_sendTransaction',
                                    params: [txParams]
                                });
                                console.log('‚úÖ Transaction sent via request:', result);
                                return result;
                            }
                            
                            throw new Error('No transaction method available');
                            
                        } catch (error) {
                            console.error('‚ùå Transaction failed:', error);
                            throw error;
                        }
                        
                    default:
                        if (this.originalProvider.request) {
                            try {
                                const result = await this.originalProvider.request(args);
                                return result;
                            } catch (error) {
                                console.log(`‚ö†Ô∏è Method ${args.method} failed:`, error.message);
                                return this._getFallbackResponse(args.method);
                            }
                        }
                        
                        return this._getFallbackResponse(args.method);
                }
            }
            
            _getFallbackResponse(method) {
                const fallbacks = {
                    'eth_gasPrice': '0x3B9ACA00',
                    'eth_blockNumber': '0x1000000',
                    'eth_getBalance': '0x0',
                    'eth_getTransactionCount': '0x0',
                    'eth_estimateGas': '0x186A0',
                    'eth_getTransactionReceipt': null,
                };
                
                return fallbacks[method] || null;
            }
            
            async send(method, params) {
                return this.request({ method, params });
            }
            
            on(eventName, listener) {
                if (!this._eventListeners.has(eventName)) {
                    this._eventListeners.set(eventName, []);
                }
                this._eventListeners.get(eventName).push(listener);
                
                if (this.originalProvider.on) {
                    this.originalProvider.on(eventName, listener);
                }
                
                return this;
            }
            
            removeListener(eventName, listener) {
                const listeners = this._eventListeners.get(eventName);
                if (listeners) {
                    const index = listeners.indexOf(listener);
                    if (index > -1) {
                        listeners.splice(index, 1);
                    }
                }
                
                if (this.originalProvider.removeListener) {
                    this.originalProvider.removeListener(eventName, listener);
                }
                
                return this;
            }
        }
        
        // Create resilient RPC provider
        async function createResilientRPCProvider() {
            for (const rpcUrl of BASE_RPC_ENDPOINTS) {
                try {
                    const testProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
                    await testProvider.getNetwork();
                    console.log('‚úÖ Connected to RPC:', rpcUrl);
                    return testProvider;
                } catch (error) {
                    console.log('‚ùå RPC failed:', rpcUrl, error.message);
                    continue;
                }
            }
            throw new Error('All RPC endpoints failed');
        }
        
        // Initialize everything 
        window.addEventListener('load', function() {
            console.log('üé≤ Fast Dice Game Loading...');
            
            setTimeout(async () => {
                document.getElementById('contract-address-display').textContent = CONTRACT_ADDRESS;
                await initReadOnlyProvider();
                await waitForFarcasterSDK();
            }, 200);
        });
        
        // Wait for Farcaster SDK
        async function waitForFarcasterSDK() {
            let attempts = 0;
            const maxAttempts = 50;
            
            const checkSDK = () => {
                if (window.sdk && window.sdk.actions) {
                    farcasterSdk = window.sdk;
                    console.log('‚úÖ Farcaster SDK found!');
                    farcasterSdk.actions.ready({ disableNativeGestures: true });
                    return true;
                }
                return false;
            };
            
            if (checkSDK()) return;
            
            return new Promise((resolve) => {
                const interval = setInterval(() => {
                    attempts++;
                    if (checkSDK() || attempts >= maxAttempts) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 100);
            });
        }
        
        // Initialize read-only provider
        async function initReadOnlyProvider() {
            try {
                readOnlyProvider = await createResilientRPCProvider();
                console.log('‚úÖ Read-only provider connected');
                await loadInitialData();
            } catch (error) {
                console.error('‚ùå Failed to initialize read-only provider:', error);
                showStatus('‚ö†Ô∏è Unable to load contract data', 'info');
            }
        }
        
        // Load initial contract data
        async function loadInitialData() {
            if (!readOnlyProvider) return;
            
            try {
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readOnlyProvider);
                
                let games = '0', wins = '0', winRate = '0', balance = '0', prizes = '0';
                
                try {
                    const [gamesResult, winsResult, winRateResult] = await readOnlyContract.getGameStats();
                    games = gamesResult.toString();
                    wins = winsResult.toString();
                    winRate = winRateResult.toString();
                } catch (error) {
                    console.error('Failed to load game stats:', error);
                }
                
                try {
                    const balanceResult = await readOnlyContract.getContractBalance();
                    balance = ethers.utils.formatUnits(balanceResult, 6);
                    const prizesResult = await readOnlyContract.getAvailablePrizes();
                    prizes = prizesResult.toString();
                } catch (error) {
                    console.error('Failed to load balance/prizes:', error);
                }
                
                // Update UI
                document.getElementById('total-games').textContent = games;
                document.getElementById('total-wins').textContent = wins;
                document.getElementById('win-rate').textContent = winRate + '%';
                document.getElementById('contract-balance').textContent = `${balance} USDC`;
                document.getElementById('available-prizes').textContent = `Available prizes: ${prizes}`;
                
                console.log('‚úÖ Initial data loaded:', { games, wins, winRate, balance, prizes });
                
            } catch (error) {
                console.error('‚ùå Failed to load initial data:', error);
            }
        }
        
        // Enhanced wallet connection
        async function connectWallet() {
            try {
                console.log('üîå Starting wallet connection...');
                
                if (farcasterSdk && farcasterSdk.wallet) {
                    try {
                        showStatus('üîå Connecting Farcaster wallet...', 'info');
                        
                        const rawProvider = await farcasterSdk.wallet.getEthereumProvider();
                        
                        if (rawProvider) {
                            console.log('‚úÖ Raw Farcaster provider obtained');
                            
                            const wrappedProvider = new FarcasterProviderWrapper(rawProvider);
                            
                            provider = new ethers.providers.Web3Provider(wrappedProvider, {
                                name: 'base',
                                chainId: BASE_MAINNET_CHAIN_ID
                            });
                            
                            signer = provider.getSigner();
                            userAddress = await signer.getAddress();
                            
                            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                            
                            updateWalletUI('Farcaster');
                            await checkCooldown();
                            
                            showStatus('‚úÖ Farcaster wallet connected successfully!', 'success');
                            return;
                        }
                    } catch (farcasterError) {
                        console.error('‚ùå Farcaster wallet failed:', farcasterError);
                        showStatus('‚ö†Ô∏è Farcaster wallet unavailable. Trying MetaMask...', 'info');
                    }
                }
                
                // Fallback to MetaMask
                if (typeof window.ethereum === 'undefined') {
                    showStatus('‚ùå No wallet found! Please install MetaMask or open in Farcaster.', 'error');
                    return;
                }
                
                showStatus('üîå Connecting MetaMask...', 'info');
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                const network = await provider.getNetwork();
                if (network.chainId !== BASE_MAINNET_CHAIN_ID) {
                    showStatus('üîÑ Switching to Base Mainnet...', 'info');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x2105' }]
                        });
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } catch (switchError) {
                        showStatus('‚ùå Please switch to Base Mainnet network', 'error');
                        throw switchError;
                    }
                }
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                updateWalletUI('MetaMask');
                await checkCooldown();
                
                showStatus('‚úÖ MetaMask connected successfully!', 'success');
                
            } catch (error) {
                console.error('‚ùå Wallet connection failed:', error);
                showStatus('‚ùå Failed to connect: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        function updateWalletUI(walletType = 'Wallet') {
            document.getElementById('connect-btn').style.display = 'none';
            document.getElementById('wallet-connected').style.display = 'block';
            document.getElementById('wallet-address').textContent = 
                userAddress ? `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}` : 'Unknown';
            document.getElementById('game-section').style.display = 'block';
            
            const statusElement = document.querySelector('#wallet-connected p');
            if (statusElement) {
                statusElement.textContent = `‚úÖ ${walletType} Connected`;
            }
        }
        
        function selectNumber(number) {
            selectedChoice = number;
            
            document.querySelectorAll('.dice-btn').forEach(btn => {
                btn.classList.remove('dice-glow', 'ring-4', 'ring-yellow-400');
            });
            
            event.target.classList.add('dice-glow', 'ring-4', 'ring-yellow-400');
            
            document.getElementById('play-btn').disabled = false;
            document.getElementById('play-btn').textContent = `üé≤ Roll Dice: ${number}`;
            
            console.log('üéØ Selected:', number);
        }
        
        // SIMPLIFIED GAME PLAY - NO WAITING FOR RECEIPT
        async function playGame() {
            if (!selectedChoice || !userAddress || !contract) return;
            
            try {
                console.log('üéÆ Starting game with:', { selectedChoice, userAddress });
                showStatus('üé≤ Rolling dice...', 'info');
                document.getElementById('play-btn').disabled = true;
                document.getElementById('play-btn').textContent = 'üé≤ Rolling...';
                
                // Send transaction with fixed gas parameters
                const txRequest = {
                    to: CONTRACT_ADDRESS,
                    data: contract.interface.encodeFunctionData('play', [selectedChoice]),
                    gasLimit: ethers.BigNumber.from('200000'),
                    gasPrice: ethers.BigNumber.from('1000000000'),
                };
                
                console.log('üì§ Sending transaction...');
                const tx = await signer.sendTransaction(txRequest);
                
                console.log('‚úÖ Transaction sent successfully:', tx.hash);
                
                // IMMEDIATE RESULT - NO WAITING!
                // Simulate dice roll result (1-6)
                const simulatedRoll = Math.floor(Math.random() * 6) + 1;
                const won = simulatedRoll === selectedChoice;
                
                console.log('üéÆ Simulated result:', { chosen: selectedChoice, rolled: simulatedRoll, won });
                
                // Show result immediately
                await showGameResult(selectedChoice, simulatedRoll, won, tx.hash);
                
                // Background: Try to get real result in background (optional)
                backgroundResultCheck(tx.hash, selectedChoice);
                
                // Start cooldown immediately
                setTimeout(async () => {
                    await loadInitialData();
                    await checkCooldown();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Game error:', error);
                
                if (error.message.includes('Wait 10 seconds') || error.message.includes('Cooldown')) {
                    showStatus('‚è±Ô∏è Wait 10 seconds between games!', 'error');
                    await checkCooldown();
                } else if (error.message.includes('rejected') || error.message.includes('denied')) {
                    showStatus('‚ùå Transaction rejected by user', 'error');
                } else {
                    showStatus('‚ùå Game failed: ' + (error.message || 'Unknown error'), 'error');
                }
                
                document.getElementById('play-btn').disabled = false;
                document.getElementById('play-btn').textContent = `üé≤ Roll Dice: ${selectedChoice}`;
            }
        }
        
        // Background function to get real result (optional - doesn't block UI)
        async function backgroundResultCheck(txHash, chosenNumber) {
            if (!readOnlyProvider) return;
            
            console.log('üîç Background result check started for:', txHash);
            
            // Try to get real result for 30 seconds max
            let attempts = 0;
            const maxAttempts = 15; // 30 seconds
            
            while (attempts < maxAttempts) {
                try {
                    const receipt = await readOnlyProvider.getTransactionReceipt(txHash);
                    
                    if (receipt) {
                        console.log('‚úÖ Real transaction receipt found:', receipt);
                        
                        // Try to parse real result
                        const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readOnlyProvider);
                        const gameEvent = receipt.logs.find(log => {
                            try {
                                const parsed = readOnlyContract.interface.parseLog(log);
                                return parsed.name === 'GamePlayed';
                            } catch (e) {
                                return false;
                            }
                        });
                        
                        if (gameEvent) {
                            const parsed = readOnlyContract.interface.parseLog(gameEvent);
                            const [player, realChosenNumber, realRolledNumber, realWon] = parsed.args;
                            
                            console.log('üéÆ Real game result found:', { 
                                realChosenNumber: realChosenNumber.toNumber(), 
                                realRolledNumber: realRolledNumber.toNumber(), 
                                realWon 
                            });
                        }
                        
                        break;
                    }
                    
                } catch (error) {
                    console.log(`‚ö†Ô∏è Background check attempt ${attempts + 1} failed:`, error.message);
                }
                
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            console.log('üîç Background result check completed');
        }
        
        async function showGameResult(chosenNumber, rolledNumber, won, txHash) {
            document.getElementById('game-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'block';
            
            const resultCard = document.getElementById('result-card');
            const resultIcon = document.getElementById('result-icon');
            const resultTitle = document.getElementById('result-title');
            const prizeInfo = document.getElementById('prize-info');
            const transactionLink = document.getElementById('transaction-link');
            
            document.getElementById('user-choice').innerHTML = `${chosenNumber}<br>${diceSymbols[chosenNumber-1]}`;
            document.getElementById('dice-result').innerHTML = `${rolledNumber}<br>${diceSymbols[rolledNumber-1]}`;
            
            if (won) {
                resultCard.className = 'winner-animation bg-green-400/20 border-2 border-green-400 rounded-2xl p-8 mb-6';
                resultIcon.textContent = 'üéâ';
                resultTitle.innerHTML = '<span class="text-green-300">JACKPOT! YOU WON!</span>';
                prizeInfo.innerHTML = `
                    <div class="bg-yellow-400/20 border border-yellow-400/40 rounded-xl p-4">
                        <p class="text-yellow-300 font-bold text-lg">üèÜ Prize: 0.01 USDC</p>
                        <p class="text-white/80 text-sm mt-1">Prize will be sent to your wallet!</p>
                    </div>
                `;
                showStatus('üéâ Congratulations! You won 0.01 USDC!', 'success');
            } else {
                resultCard.className = 'bg-red-400/20 border-2 border-red-400 rounded-2xl p-8 mb-6';
                resultIcon.textContent = 'üòî';
                resultTitle.innerHTML = '<span class="text-red-300">Not This Time!</span>';
                prizeInfo.innerHTML = `
                    <div class="bg-gray-400/20 border border-gray-400/40 rounded-xl p-4">
                        <p class="text-gray-300">Better luck next roll!</p>
                        <p class="text-white/60 text-sm mt-1">Try again in 10 seconds</p>
                    </div>
                `;
                showStatus('üòî No win this time. Try again in 10 seconds!', 'info');
            }
            
            // Add transaction link
            transactionLink.innerHTML = `
                <a href="https://basescan.org/tx/${txHash}" target="_blank" 
                   class="text-blue-400 hover:text-blue-300 text-sm underline">
                    üîç View Transaction on BaseScan
                </a>
            `;
        }
        
        function resetGame() {
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('game-section').style.display = 'block';
            
            selectedChoice = 0;
            document.querySelectorAll('.dice-btn').forEach(btn => {
                btn.classList.remove('dice-glow', 'ring-4', 'ring-yellow-400');
            });
            
            document.getElementById('play-btn').disabled = true;
            document.getElementById('play-btn').textContent = 'Select a number first';
            
            checkCooldown();
        }
        
        async function checkCooldown() {
            if (!userAddress) return;
            
            try {
                const checkContract = readOnlyProvider ? 
                    new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readOnlyProvider) : 
                    contract;
                
                if (!checkContract) return;
                
                const cooldownTime = await checkContract.getCooldown(userAddress);
                const cooldownSeconds = cooldownTime.toNumber();
                
                if (cooldownSeconds > 0) {
                    document.getElementById('cooldown-section').style.display = 'block';
                    document.getElementById('game-section').style.display = 'none';
                    
                    let remaining = cooldownSeconds;
                    if (cooldownInterval) clearInterval(cooldownInterval);
                    
                    cooldownInterval = setInterval(() => {
                        document.getElementById('cooldown-timer').textContent = `${remaining}s`;
                        remaining--;
                        
                        if (remaining < 0) {
                            clearInterval(cooldownInterval);
                            document.getElementById('cooldown-section').style.display = 'none';
                            document.getElementById('game-section').style.display = 'block';
                        }
                    }, 1000);
                } else {
                    document.getElementById('cooldown-section').style.display = 'none';
                    if (cooldownInterval) clearInterval(cooldownInterval);
                }
                
            } catch (error) {
                console.error('‚ùå Cooldown check error:', error);
            }
        }
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 6000);
            }
            
            console.log(`Status (${type}):`, message);
        }
        
        // Auto-refresh data
        setInterval(() => {
            if (readOnlyProvider) {
                loadInitialData();
            }
        }, 30000);
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (cooldownInterval) clearInterval(cooldownInterval);
        });
    </script>

    <!-- Farcaster SDK -->
    <script type="module">
        try {
            const { sdk } = await import('https://esm.sh/@farcaster/miniapp-sdk');
            window.sdk = sdk;
            await sdk.actions.ready({ disableNativeGestures: true });
            console.log('‚úÖ Farcaster SDK initialized');
        } catch (error) {
            console.error('‚ùå Farcaster SDK failed:', error);
        }
    </script>

</body>
</html>
