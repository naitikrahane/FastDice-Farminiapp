<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≤ Fast Dice Game - Base Mainnet</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "wagmi": "https://esm.sh/wagmi@2.12.17",
        "wagmi/chains": "https://esm.sh/wagmi@2.12.17/chains",
        "viem": "https://esm.sh/viem@2.21.19",
        "@farcaster/miniapp-wagmi-connector": "https://esm.sh/@farcaster/miniapp-wagmi-connector@0.1.7",
        "@tanstack/react-query": "https://esm.sh/@tanstack/react-query@5.59.20",
        "react": "https://esm.sh/react@18.3.1",
        "react-dom": "https://esm.sh/react-dom@18.3.1"
      }
    }
    </script>
    <style>
        .dice-glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .winner-animation { animation: bounce 1s infinite; }
        .gradient-text { background: linear-gradient(45deg, #f59e0b, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">
    
    <div class="max-w-lg w-full">
        
        <!-- Header -->
        <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl mb-6 border border-white/20">
            <div class="text-center">
                <h1 class="text-5xl font-bold text-white mb-2">üé≤</h1>
                <h2 class="text-3xl font-bold gradient-text mb-4">Fast Dice Game</h2>
                <div class="flex justify-center space-x-4 text-sm text-white/70">
                    <span>‚ö° Base Mainnet</span>
                    <span>üí∞ 0.01 USDC Prize</span>
                    <span>‚è±Ô∏è 10s Cooldown</span>
                </div>
            </div>
        </div>

        <!-- React App Container -->
        <div id="react-app"></div>
        
        <!-- Contract Info -->
        <div class="mt-6 text-center text-white/50 text-xs">
            <p class="mb-1">üìÑ FastDiceGame Contract</p>
            <p>0xeA3F62030029DD99E487f6A3c415dc31e03337FD</p>
        </div>
    </div>

    <script type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom';
        import { http, createConfig } from 'wagmi';
        import { base } from 'wagmi/chains';
        import { farcasterMiniApp } from '@farcaster/miniapp-wagmi-connector';
        import { WagmiProvider, useAccount, useConnect, useWriteContract, useReadContract, useWaitForTransactionReceipt } from 'wagmi';
        import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
        import { parseEther, formatUnits } from 'viem';

        // Wagmi Configuration (Official Farcaster Method)
        const config = createConfig({
            chains: [base],
            transports: {
                [base.id]: http(),
            },
            connectors: [
                farcasterMiniApp()
            ]
        });

        const queryClient = new QueryClient();

        // Contract Configuration
        const CONTRACT_ADDRESS = "0xeA3F62030029DD99E487f6A3c415dc31e03337FD";
        const CONTRACT_ABI = [
            "function play(uint256 chosenNumber) external",
            "function getCooldown(address player) external view returns (uint256)",
            "function getContractBalance() external view returns (uint256)",
            "function getAvailablePrizes() external view returns (uint256)",
            "function getGameStats() external view returns (uint256 games, uint256 wins, uint256 winRate)",
            "function lastPlayTime(address) external view returns (uint256)",
            "event GamePlayed(address indexed player, uint256 chosenNumber, uint256 rolledNumber, bool won)",
            "event PrizeClaimed(address indexed player, uint256 amount)"
        ];

        // Dice Component
        function DiceGame() {
            const { isConnected, address } = useAccount();
            const { connect, connectors } = useConnect();
            const [selectedChoice, setSelectedChoice] = useState(0);
            const [gameResult, setGameResult] = useState(null);
            const [cooldown, setCooldown] = useState(0);

            const diceSymbols = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];

            // Contract Reads
            const { data: gameStats } = useReadContract({
                address: CONTRACT_ADDRESS,
                abi: CONTRACT_ABI,
                functionName: 'getGameStats',
            });

            const { data: contractBalance } = useReadContract({
                address: CONTRACT_ADDRESS,
                abi: CONTRACT_ABI,
                functionName: 'getContractBalance',
            });

            const { data: availablePrizes } = useReadContract({
                address: CONTRACT_ADDRESS,
                abi: CONTRACT_ABI,
                functionName: 'getAvailablePrizes',
            });

            const { data: playerCooldown } = useReadContract({
                address: CONTRACT_ADDRESS,
                abi: CONTRACT_ABI,
                functionName: 'getCooldown',
                args: address ? [address] : undefined,
            });

            // Contract Write
            const { writeContract, data: hash, isPending, error } = useWriteContract();

            // Transaction Receipt
            const { isLoading: isConfirming, isSuccess: isConfirmed } = useWaitForTransactionReceipt({
                hash,
            });

            // Cooldown timer
            useEffect(() => {
                if (playerCooldown && Number(playerCooldown) > 0) {
                    setCooldown(Number(playerCooldown));
                    const timer = setInterval(() => {
                        setCooldown(prev => {
                            if (prev <= 1) {
                                clearInterval(timer);
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                    return () => clearInterval(timer);
                }
            }, [playerCooldown]);

            const playGame = () => {
                if (!selectedChoice || !isConnected) return;

                writeContract({
                    address: CONTRACT_ADDRESS,
                    abi: CONTRACT_ABI,
                    functionName: 'play',
                    args: [selectedChoice],
                });
            };

            const resetGame = () => {
                setGameResult(null);
                setSelectedChoice(0);
            };

            if (!isConnected) {
                return (
                    React.createElement('div', { className: 'bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl border border-white/20' },
                        React.createElement('div', { className: 'text-center mb-8' },
                            React.createElement('button', {
                                onClick: () => connect({ connector: connectors[0] }),
                                className: 'bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 shadow-xl'
                            }, 
                                React.createElement('span', { className: 'mr-2' }, 'üîó'),
                                ' Connect Farcaster Wallet'
                            )
                        ),

                        // Stats (always visible)
                        React.createElement('div', { className: 'grid grid-cols-3 gap-4 mb-8' },
                            React.createElement('div', { className: 'bg-black/20 rounded-xl p-3 text-center' },
                                React.createElement('div', { className: 'text-2xl font-bold text-white' }, gameStats ? gameStats[0]?.toString() || '0' : '0'),
                                React.createElement('div', { className: 'text-xs text-white/60' }, 'Total Games')
                            ),
                            React.createElement('div', { className: 'bg-black/20 rounded-xl p-3 text-center' },
                                React.createElement('div', { className: 'text-2xl font-bold text-green-400' }, gameStats ? gameStats[1]?.toString() || '0' : '0'),
                                React.createElement('div', { className: 'text-xs text-white/60' }, 'Total Wins')
                            ),
                            React.createElement('div', { className: 'bg-black/20 rounded-xl p-3 text-center' },
                                React.createElement('div', { className: 'text-2xl font-bold text-yellow-400' }, gameStats ? gameStats[2]?.toString() + '%' || '0%' : '0%'),
                                React.createElement('div', { className: 'text-xs text-white/60' }, 'Win Rate')
                            )
                        ),

                        // Contract Balance
                        React.createElement('div', { className: 'bg-yellow-400/20 border border-yellow-400/40 rounded-2xl p-4 text-center' },
                            React.createElement('p', { className: 'text-yellow-300 font-semibold' }, 'üí∞ Prize Pool'),
                            React.createElement('p', { className: 'text-white text-lg font-mono' }, contractBalance ? `${formatUnits(contractBalance, 6)} USDC` : 'Loading...'),
                            React.createElement('p', { className: 'text-yellow-200 text-sm' }, `Available prizes: ${availablePrizes?.toString() || '0'}`)
                        )
                    )
                );
            }

            return (
                React.createElement('div', { className: 'bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl border border-white/20' },
                    
                    // Connected Status
                    React.createElement('div', { className: 'bg-green-500/20 border border-green-400/30 rounded-2xl p-4 mb-8 text-center' },
                        React.createElement('p', { className: 'text-green-300 font-semibold mb-2' }, '‚úÖ Farcaster Wallet Connected'),
                        React.createElement('p', { className: 'text-white/70 text-sm font-mono' }, address ? `${address.slice(0, 6)}...${address.slice(-4)}` : '')
                    ),

                    // Stats
                    React.createElement('div', { className: 'grid grid-cols-3 gap-4 mb-8' },
                        React.createElement('div', { className: 'bg-black/20 rounded-xl p-3 text-center' },
                            React.createElement('div', { className: 'text-2xl font-bold text-white' }, gameStats ? gameStats[0]?.toString() || '0' : '0'),
                            React.createElement('div', { className: 'text-xs text-white/60' }, 'Total Games')
                        ),
                        React.createElement('div', { className: 'bg-black/20 rounded-xl p-3 text-center' },
                            React.createElement('div', { className: 'text-2xl font-bold text-green-400' }, gameStats ? gameStats[1]?.toString() || '0' : '0'),
                            React.createElement('div', { className: 'text-xs text-white/60' }, 'Total Wins')
                        ),
                        React.createElement('div', { className: 'bg-black/20 rounded-xl p-3 text-center' },
                            React.createElement('div', { className: 'text-2xl font-bold text-yellow-400' }, gameStats ? gameStats[2]?.toString() + '%' || '0%' : '0%'),
                            React.createElement('div', { className: 'text-xs text-white/60' }, 'Win Rate')
                        )
                    ),

                    // Contract Balance
                    React.createElement('div', { className: 'bg-yellow-400/20 border border-yellow-400/40 rounded-2xl p-4 mb-6 text-center' },
                        React.createElement('p', { className: 'text-yellow-300 font-semibold' }, 'üí∞ Prize Pool'),
                        React.createElement('p', { className: 'text-white text-lg font-mono' }, contractBalance ? `${formatUnits(contractBalance, 6)} USDC` : 'Loading...'),
                        React.createElement('p', { className: 'text-yellow-200 text-sm' }, `Available prizes: ${availablePrizes?.toString() || '0'}`)
                    ),

                    // Cooldown Timer
                    cooldown > 0 && React.createElement('div', { className: 'bg-red-400/20 border border-red-400/40 rounded-2xl p-4 mb-6 text-center' },
                        React.createElement('p', { className: 'text-red-300 font-semibold' }, '‚è±Ô∏è Cooldown Active'),
                        React.createElement('p', { className: 'text-white text-2xl font-mono' }, `${cooldown}s`),
                        React.createElement('p', { className: 'text-red-200 text-sm' }, 'Wait before next game')
                    ),

                    // Game Section (only if no cooldown)
                    cooldown === 0 && !gameResult && React.createElement('div', null,
                        React.createElement('h3', { className: 'text-white text-center font-bold text-xl mb-6' }, 'üéØ Choose Your Number (1-6)'),
                        
                        React.createElement('div', { className: 'grid grid-cols-3 gap-4 mb-8' },
                            [1,2,3,4,5,6].map(num => 
                                React.createElement('button', {
                                    key: num,
                                    onClick: () => setSelectedChoice(num),
                                    className: `dice-btn bg-gradient-to-br ${getButtonColor(num)} text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110 ${selectedChoice === num ? 'ring-4 ring-yellow-400' : ''}`
                                },
                                    React.createElement('div', { className: 'text-4xl' }, diceSymbols[num-1]),
                                    React.createElement('div', { className: 'text-sm mt-1' }, num)
                                )
                            )
                        ),
                        
                        React.createElement('button', {
                            onClick: playGame,
                            disabled: !selectedChoice || isPending || isConfirming,
                            className: 'w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-2xl font-bold text-xl hover:from-green-600 hover:to-emerald-700 transition-all transform hover:scale-105 shadow-xl disabled:opacity-50 disabled:cursor-not-allowed'
                        }, isPending ? 'üé≤ Rolling...' : isConfirming ? '‚è≥ Confirming...' : selectedChoice ? `üé≤ Roll Dice: ${selectedChoice}` : 'Select a number first')
                    ),

                    // Transaction Status
                    hash && React.createElement('div', { className: 'mt-4 text-center' },
                        React.createElement('p', { className: 'text-white/70 text-sm' }, `Transaction: ${hash.slice(0, 10)}...`),
                        isConfirming && React.createElement('p', { className: 'text-yellow-300' }, '‚è≥ Waiting for confirmation...'),
                        isConfirmed && React.createElement('p', { className: 'text-green-300' }, '‚úÖ Transaction confirmed!')
                    ),

                    // Error Display
                    error && React.createElement('div', { className: 'mt-4 bg-red-400/20 border border-red-400/40 rounded-xl p-4 text-center' },
                        React.createElement('p', { className: 'text-red-300 font-semibold' }, '‚ùå Error'),
                        React.createElement('p', { className: 'text-white text-sm' }, error.message || 'Transaction failed')
                    )
                )
            );
        }

        function getButtonColor(num) {
            const colors = [
                'from-red-400 to-red-600',
                'from-orange-400 to-orange-600', 
                'from-yellow-400 to-yellow-600',
                'from-green-400 to-green-600',
                'from-blue-400 to-blue-600',
                'from-purple-400 to-purple-600'
            ];
            return colors[num-1];
        }

        // Main App Component
        function App() {
            return React.createElement(WagmiProvider, { config },
                React.createElement(QueryClientProvider, { client: queryClient },
                    React.createElement(DiceGame)
                )
            );
        }

        // Initialize Farcaster SDK and React
        async function initializeApp() {
            // Wait for Farcaster SDK
            const { sdk } = await import('https://esm.sh/@farcaster/miniapp-sdk');
            
            // Initialize Farcaster
            await sdk.actions.ready({ disableNativeGestures: true });
            console.log('‚úÖ Farcaster SDK initialized');

            // Mount React App
            const root = createRoot(document.getElementById('react-app'));
            root.render(React.createElement(App));
            
            console.log('‚úÖ React App mounted with Wagmi');
        }

        // Start the app
        initializeApp().catch(console.error);
    </script>

</body>
</html>
