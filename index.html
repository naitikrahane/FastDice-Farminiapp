<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≤ Fast Dice Game - Base Mainnet</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .dice-glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .winner-animation { animation: bounce 1s infinite; }
        .gradient-text { background: linear-gradient(45deg, #f59e0b, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        @keyframes bounce { 0%, 100% { transform: translateY(-5%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); } 50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); } }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">
    
    <div class="max-w-lg w-full">
        
        <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl mb-6 border border-white/20">
            <div class="text-center">
                <h1 class="text-5xl font-bold text-white mb-2">üé≤</h1>
                <h2 class="text-3xl font-bold gradient-text mb-4">Fast Dice Game</h2>
                <div class="flex justify-center space-x-4 text-sm text-white/70">
                    <span>‚ö° Base Mainnet</span>
                    <span>üí∞ 0.01 USDC Prize</span>
                    <span>‚è±Ô∏è 10s Cooldown</span>
                </div>
            </div>
        </div>

        <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl border border-white/20">
            
            <div id="wallet-section" class="text-center mb-8">
                <button id="connect-btn" onclick="connectWallet()" 
                        class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 shadow-xl">
                    <span class="mr-2">üîó</span> Connect Wallet
                </button>
                
                <div id="wallet-connected" style="display: none;" class="bg-green-500/20 border border-green-400/30 rounded-2xl p-4 mt-4">
                    <p class="text-green-300 font-semibold mb-2">‚úÖ Wallet Connected</p>
                    <p id="wallet-address" class="text-white/70 text-sm font-mono"></p>
                </div>
            </div>

            <div id="game-stats" class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-black/20 rounded-xl p-3 text-center">
                    <div id="total-games" class="text-2xl font-bold text-white">0</div>
                    <div class="text-xs text-white/60">Total Games</div>
                </div>
                <div class="bg-black/20 rounded-xl p-3 text-center">
                    <div id="total-wins" class="text-2xl font-bold text-green-400">0</div>
                    <div class="text-xs text-white/60">Total Wins</div>
                </div>
                <div class="bg-black/20 rounded-xl p-3 text-center">
                    <div id="win-rate" class="text-2xl font-bold text-yellow-400">0%</div>
                    <div class="text-xs text-white/60">Win Rate</div>
                </div>
            </div>

            <div id="contract-info" class="bg-yellow-400/20 border border-yellow-400/40 rounded-2xl p-4 mb-6 text-center">
                <p class="text-yellow-300 font-semibold">üí∞ Prize Pool</p>
                <p id="contract-balance" class="text-white text-lg font-mono">Loading...</p>
                <p id="available-prizes" class="text-yellow-200 text-sm">Available prizes: 0</p>
            </div>

            <div id="cooldown-section" style="display: none;" class="bg-red-400/20 border border-red-400/40 rounded-2xl p-4 mb-6 text-center">
                <p class="text-red-300 font-semibold">‚è±Ô∏è Cooldown Active</p>
                <p id="cooldown-timer" class="text-white text-2xl font-mono">0s</p>
                <p class="text-red-200 text-sm">Wait before next game</p>
            </div>

            <div id="game-section" style="display: none;">
                <h3 class="text-white text-center font-bold text-xl mb-6">üéØ Choose Your Number (1-6)</h3>
                
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <button class="dice-btn bg-gradient-to-br from-red-400 to-red-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(1)">
                        <div class="text-4xl">‚öÄ</div><div class="text-sm mt-1">1</div>
                    </button>
                    <button class="dice-btn bg-gradient-to-br from-orange-400 to-orange-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(2)">
                        <div class="text-4xl">‚öÅ</div><div class="text-sm mt-1">2</div>
                    </button>
                    <button class="dice-btn bg-gradient-to-br from-yellow-400 to-yellow-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(3)">
                        <div class="text-4xl">‚öÇ</div><div class="text-sm mt-1">3</div>
                    </button>
                    <button class="dice-btn bg-gradient-to-br from-green-400 to-green-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(4)">
                        <div class="text-4xl">‚öÉ</div><div class="text-sm mt-1">4</div>
                    </button>
                    <button class="dice-btn bg-gradient-to-br from-blue-400 to-blue-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(5)">
                        <div class="text-4xl">‚öÑ</div><div class="text-sm mt-1">5</div>
                    </button>
                    <button class="dice-btn bg-gradient-to-br from-purple-400 to-purple-600 text-white text-3xl font-bold aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-lg transition-all hover:scale-110" onclick="selectNumber(6)">
                        <div class="text-4xl">‚öÖ</div><div class="text-sm mt-1">6</div>
                    </button>
                </div>
                
                <button id="play-btn" onclick="playGame()" disabled
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-2xl font-bold text-xl hover:from-green-600 hover:to-emerald-700 transition-all transform hover:scale-105 shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
                    Select a number first
                </button>
            </div>

            <div id="result-section" style="display: none;" class="text-center mt-6">
                <div id="result-card" class="rounded-2xl p-8 mb-6">
                    <div id="result-icon" class="text-8xl mb-4"></div>
                    <h3 id="result-title" class="font-bold text-2xl mb-4"></h3>
                    <div class="grid grid-cols-2 gap-4 text-lg mb-4">
                        <div class="bg-black/20 rounded-xl p-3">
                            <p class="text-white/70 text-sm">Your Choice</p>
                            <p id="user-choice" class="text-2xl font-bold text-yellow-300"></p>
                        </div>
                        <div class="bg-black/20 rounded-xl p-3">
                            <p class="text-white/70 text-sm">Dice Result</p>
                            <p id="dice-result" class="text-2xl font-bold text-yellow-300"></p>
                        </div>
                    </div>
                    <div id="prize-info"></div>
                </div>
                
                <button onclick="resetGame()" 
                        class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white py-4 rounded-2xl font-bold text-xl hover:from-gray-600 hover:to-gray-700 transition-all">
                    üé≤ Play Again
                </button>
            </div>
        </div>
        
        <div id="status-message" class="mt-6 text-center" style="display: none;">
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4 border border-white/20">
                <p id="status-text" class="text-white"></p>
            </div>
        </div>
        
        <div class="mt-6 text-center text-white/50 text-xs">
            <p class="mb-1">üìÑ FastDiceGame Contract</p>
            <p id="contract-address-display">Deploy and update address</p>
        </div>
    </div>

    <script>
        // Contract Configuration
        const CONTRACT_ADDRESS = "0xeA3F62030029DD99E487f6A3c415dc31e03337FD";
        const BASE_MAINNET_CHAIN_ID = 8453;
        
        const BASE_RPC_ENDPOINTS = [
            'https://mainnet.base.org',
            'https://base-mainnet.public.blastapi.io',
            'https://base.gateway.tenderly.co',
            'https://base-rpc.publicnode.com'
        ];
        
        const CONTRACT_ABI = [
            "function play(uint256 chosenNumber) external",
            "function getCooldown(address player) external view returns (uint256)",
            "function getContractBalance() external view returns (uint256)",
            "function getAvailablePrizes() external view returns (uint256)",
            "function getGameStats(address player) external view returns (uint256 games, uint256 wins, uint256 winRate)",
            "function lastPlayTime(address) external view returns (uint256)",
            "event GamePlayed(address indexed player, uint256 chosenNumber, uint256 rolledNumber, bool won)",
            "event PrizeClaimed(address indexed player, uint256 amount)"
        ];
        
        let provider, signer, contract, userAddress;
        let readOnlyProvider;
        let selectedChoice = 0;
        let cooldownInterval;
        let farcasterSdk = null;
        
        const diceSymbols = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
        
        /**
         * A robust provider wrapper to ensure EIP-1193 compatibility.
         * It translates legacy provider methods (.send, .sendAsync) into the modern .request() method
         * that ethers.js expects, fixing compatibility issues with wallets like Farcaster's.
         */
        class ProviderCompatibilityBridge {
            constructor(originalProvider) {
                this.originalProvider = originalProvider;
            }
        
            async request(args) {
                const { method, params } = args;
        
                // Priority 1: Modern .request() method
                if (typeof this.originalProvider.request === 'function') {
                    return this.originalProvider.request(args);
                }
        
                // Priority 2: Legacy .send(method, params)
                if (typeof this.originalProvider.send === 'function') {
                    return this.originalProvider.send(method, params || []);
                }
                
                // Priority 3: Very old .sendAsync(payload, callback)
                if (typeof this.originalProvider.sendAsync === 'function') {
                    return new Promise((resolve, reject) => {
                        this.originalProvider.sendAsync({
                            jsonrpc: '2.0',
                            id: new Date().getTime(),
                            method,
                            params: params || [],
                        }, (error, response) => {
                            if (error) return reject(error);
                            if (response.error) return reject(new Error(response.error.message));
                            resolve(response.result);
                        });
                    });
                }
                
                throw new Error(`The wallet provider does not support any known request methods.`);
            }
            
            // Pass through event listeners
            on(eventName, listener) {
                if (typeof this.originalProvider.on === 'function') {
                    this.originalProvider.on(eventName, listener);
                }
                return this;
            }
            
            removeListener(eventName, listener) {
                if (typeof this.originalProvider.removeListener === 'function') {
                    this.originalProvider.removeListener(eventName, listener);
                }
                return this;
            }
        }
        
        async function createResilientRPCProvider() {
            for (const rpcUrl of BASE_RPC_ENDPOINTS) {
                try {
                    const testProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
                    await testProvider.getNetwork();
                    console.log('‚úÖ Connected to RPC:', rpcUrl);
                    return testProvider;
                } catch (error) {
                    console.log('‚ùå RPC failed:', rpcUrl, error.message);
                }
            }
            throw new Error('All RPC endpoints failed');
        }
        
        window.addEventListener('load', async () => {
            console.log('üé≤ Fast Dice Game Loading...');
            document.getElementById('contract-address-display').textContent = CONTRACT_ADDRESS;
            await initReadOnlyProvider();
            await waitForFarcasterSDK();
        });
        
        async function waitForFarcasterSDK() {
            let attempts = 0;
            const maxAttempts = 50; // Wait for 5 seconds
            
            const checkSDK = () => {
                if (window.sdk && window.sdk.actions) {
                    farcasterSdk = window.sdk;
                    console.log('‚úÖ Farcaster SDK found!');
                    farcasterSdk.actions.ready({ disableNativeGestures: true });
                    return true;
                }
                return false;
            };
            
            if (checkSDK()) return;
            
            return new Promise((resolve) => {
                const interval = setInterval(() => {
                    attempts++;
                    if (checkSDK() || attempts >= maxAttempts) {
                        clearInterval(interval);
                        if (attempts >= maxAttempts) console.warn('‚ö†Ô∏è Farcaster SDK not found after waiting');
                        resolve();
                    }
                }, 100);
            });
        }
        
        async function initReadOnlyProvider() {
            try {
                readOnlyProvider = await createResilientRPCProvider();
                console.log('‚úÖ Read-only provider connected');
                await updateContractInfo();
            } catch (error) {
                console.error('‚ùå Failed to initialize read-only provider:', error);
                showStatus('‚ö†Ô∏è Unable to load contract data', 'info');
            }
        }
        
        async function updateContractInfo() {
            if (!readOnlyProvider) return;
            try {
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readOnlyProvider);
                const balance = await readOnlyContract.getContractBalance();
                const prizes = await readOnlyContract.getAvailablePrizes();
                
                document.getElementById('contract-balance').textContent = `${ethers.utils.formatUnits(balance, 6)} USDC`;
                document.getElementById('available-prizes').textContent = `Available prizes: ${prizes.toString()}`;
            } catch (error) {
                console.error('‚ùå Failed to load contract info:', error);
                document.getElementById('contract-balance').textContent = 'Error';
            }
        }
        
        async function updatePlayerStats() {
            if (!userAddress || !readOnlyProvider) return;
            try {
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readOnlyProvider);
                const stats = await readOnlyContract.getGameStats(userAddress);
                document.getElementById('total-games').textContent = stats.games.toString();
                document.getElementById('total-wins').textContent = stats.wins.toString();
                document.getElementById('win-rate').textContent = stats.winRate.toString() + '%';
            } catch (error) {
                console.error('‚ùå Failed to load player stats:', error);
            }
        }

        async function connectWallet() {
            try {
                // Try Farcaster wallet first
                if (farcasterSdk && farcasterSdk.wallet) {
                    try {
                        showStatus('üîå Connecting Farcaster wallet...', 'info');
                        const rawProvider = await farcasterSdk.wallet.getEthereumProvider();
                        if (!rawProvider) throw new Error("Farcaster provider not found.");

                        console.log('‚úÖ Raw Farcaster provider obtained, creating compatibility bridge...');
                        const bridgedProvider = new ProviderCompatibilityBridge(rawProvider);
                        provider = new ethers.providers.Web3Provider(bridgedProvider, 'any');
                        
                        const network = await provider.getNetwork();
                        if (network.chainId !== BASE_MAINNET_CHAIN_ID) {
                            showStatus(`‚ùå Wrong Network! Please switch to Base Mainnet.`, 'error');
                            throw new Error(`Wrong network. Expected ${BASE_MAINNET_CHAIN_ID}, got ${network.chainId}`);
                        }
                        
                        signer = provider.getSigner();
                        userAddress = await signer.getAddress();
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                        
                        console.log('‚úÖ Farcaster wallet connected:', userAddress);
                        showStatus('‚úÖ Farcaster wallet connected successfully!', 'success');
                        onConnect();
                        return;

                    } catch (farcasterError) {
                        console.error('‚ùå Farcaster wallet failed:', farcasterError);
                        showStatus('‚ö†Ô∏è Farcaster wallet unavailable. Trying MetaMask...', 'info');
                    }
                }
                
                // Fallback to MetaMask
                if (typeof window.ethereum === 'undefined') {
                    showStatus('‚ùå No wallet found! Install MetaMask or open in Farcaster.', 'error');
                    return;
                }
                
                showStatus('üîå Connecting MetaMask...', 'info');
                provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
                await provider.send("eth_requestAccounts", []);

                const network = await provider.getNetwork();
                if (network.chainId !== BASE_MAINNET_CHAIN_ID) {
                    showStatus('üîÑ Switching to Base Mainnet...', 'info');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: `0x${BASE_MAINNET_CHAIN_ID.toString(16)}` }]
                        });
                        // Re-initialize provider after network switch
                        provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
                    } catch (switchError) {
                        showStatus('‚ùå Please switch to Base Mainnet network', 'error');
                        throw switchError;
                    }
                }
                
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                showStatus('‚úÖ MetaMask connected successfully!', 'success');
                onConnect();
                
            } catch (error) {
                console.error('‚ùå Wallet connection failed:', error);
                showStatus('‚ùå Failed to connect: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        function onConnect() {
            updateWalletUI();
            updatePlayerStats();
            checkCooldown();
        }

        function updateWalletUI() {
            document.getElementById('connect-btn').style.display = 'none';
            document.getElementById('wallet-connected').style.display = 'block';
            document.getElementById('wallet-address').textContent = userAddress ? `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}` : '';
            document.getElementById('game-section').style.display = 'block';
        }
        
        function selectNumber(number) {
            selectedChoice = number;
            document.querySelectorAll('.dice-btn').forEach(btn => {
                btn.classList.remove('dice-glow', 'ring-4', 'ring-yellow-400');
            });
            event.currentTarget.classList.add('dice-glow', 'ring-4', 'ring-yellow-400');
            const playBtn = document.getElementById('play-btn');
            playBtn.disabled = false;
            playBtn.textContent = `üé≤ Roll Dice: ${number}`;
        }
        
        async function playGame() {
            if (!selectedChoice || !contract) return;
            
            const playBtn = document.getElementById('play-btn');
            playBtn.disabled = true;
            playBtn.textContent = 'üé≤ Rolling...';
            showStatus('üé≤ Rolling dice... Confirm transaction in your wallet.', 'info');
            
            try {
                const tx = await contract.play(selectedChoice);
                showStatus('‚è≥ Transaction sent, waiting for confirmation...', 'info');
                
                const receipt = await tx.wait();
                const gameEvent = receipt.events?.find(e => e.event === 'GamePlayed');
                
                if (gameEvent) {
                    const [player, chosen, rolled, won] = gameEvent.args;
                    await showGameResult(chosen.toNumber(), rolled.toNumber(), won);
                } else {
                    showStatus('‚ö†Ô∏è Game completed but result unclear.', 'warning');
                    resetGame();
                }

                updatePlayerStats();
                updateContractInfo();
                checkCooldown();
                
            } catch (error) {
                console.error('‚ùå Game error:', error);
                let message = '‚ùå Game failed. See console for details.';
                if (error.reason) message = `‚ùå Error: ${error.reason}`;
                else if (error.message.includes('rejected')) message = '‚ùå Transaction rejected.';
                showStatus(message, 'error');
                resetGame();
            }
        }
        
        function showGameResult(chosen, rolled, won) {
            document.getElementById('game-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'block';
            
            const resultCard = document.getElementById('result-card');
            const resultIcon = document.getElementById('result-icon');
            const resultTitle = document.getElementById('result-title');
            const prizeInfo = document.getElementById('prize-info');
            
            document.getElementById('user-choice').innerHTML = `${chosen}<br>${diceSymbols[chosen-1]}`;
            document.getElementById('dice-result').innerHTML = `${rolled}<br>${diceSymbols[rolled-1]}`;
            
            if (won) {
                resultCard.className = 'winner-animation bg-green-400/20 border-2 border-green-400 rounded-2xl p-8 mb-6';
                resultIcon.textContent = 'üéâ';
                resultTitle.innerHTML = '<span class="text-green-300">JACKPOT! YOU WON!</span>';
                prizeInfo.innerHTML = `<div class="bg-yellow-400/20 rounded-xl p-4"><p class="text-yellow-300 font-bold text-lg">üèÜ 0.01 USDC sent!</p></div>`;
                showStatus('üéâ Congratulations! You won 0.01 USDC!', 'success');
            } else {
                resultCard.className = 'bg-red-400/20 border-2 border-red-400 rounded-2xl p-8 mb-6';
                resultIcon.textContent = 'üòî';
                resultTitle.innerHTML = '<span class="text-red-300">Not This Time!</span>';
                prizeInfo.innerHTML = `<div class="bg-gray-400/20 rounded-xl p-4"><p class="text-gray-300">Better luck next roll!</p></div>`;
                showStatus('üòî No win this time. Try again in 10 seconds!', 'info');
            }
        }
        
        function resetGame() {
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('game-section').style.display = 'block';
            selectedChoice = 0;
            document.querySelectorAll('.dice-btn').forEach(btn => btn.classList.remove('dice-glow', 'ring-4', 'ring-yellow-400'));
            const playBtn = document.getElementById('play-btn');
            playBtn.disabled = true;
            playBtn.textContent = 'Select a number first';
            checkCooldown();
        }
        
        async function checkCooldown() {
            if (!userAddress || !readOnlyProvider) return;
            try {
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readOnlyProvider);
                const cooldownSeconds = (await readOnlyContract.getCooldown(userAddress)).toNumber();
                
                if (cooldownSeconds > 0) {
                    document.getElementById('cooldown-section').style.display = 'block';
                    document.getElementById('game-section').style.display = 'none';
                    let remaining = cooldownSeconds;
                    if (cooldownInterval) clearInterval(cooldownInterval);
                    
                    cooldownInterval = setInterval(() => {
                        document.getElementById('cooldown-timer').textContent = `${remaining}s`;
                        remaining--;
                        if (remaining < 0) {
                            clearInterval(cooldownInterval);
                            document.getElementById('cooldown-section').style.display = 'none';
                            document.getElementById('game-section').style.display = 'block';
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('‚ùå Cooldown check error:', error);
            }
        }
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            const statusText = document.getElementById('status-text');
            statusText.textContent = message;
            statusDiv.style.display = 'block';
            
            // Do not auto-hide errors
            if (type !== 'error') {
                setTimeout(() => {
                    if (statusText.textContent === message) {
                       statusDiv.style.display = 'none';
                    }
                }, 5000);
            }
            console.log(`Status (${type}):`, message);
        }
        
        // Auto-refresh contract data
        setInterval(updateContractInfo, 30000);
        
        window.addEventListener('beforeunload', () => {
            if (cooldownInterval) clearInterval(cooldownInterval);
        });
    </script>

    <script type="module">
        try {
            const { sdk } = await import('https://esm.sh/@farcaster/miniapp-sdk');
            window.sdk = sdk;
            console.log('‚úÖ Farcaster SDK initialized');
        } catch (error) {
            console.error('‚ùå Farcaster SDK failed to load:', error);
        }
    </script>

</body>
</html>
